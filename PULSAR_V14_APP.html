<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PULSAR V14 â€” App Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
  
:root {
  --critical: #D63C3C;
  --severe: #F08A2B;
  --moderate: #E5C84B;
  --mild: #5FA8FF;
  --stable: #3BC17A;
  --vps: #6C7CFF;
  --tde: #2FD1C8;
  --pve: #B96BFF;
  --accent: #2FD1C8;

  --radius-badge: 10px;
  --radius-button: 8px;
  --radius-card: 10px;
  --radius-modal: 14px;

  --u: 4px;
  --xs: 8px;
  --sm: 12px;
  --md: 16px;
  --lg: 20px;
  --xl: 24px;
  --2xl: 32px;

  --font-ui: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  --font-mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
}

[data-theme="dark"] {
  --bg0: #0B0F14;
  --bg1: #0F1520;
  --bg2: #141C2A;
  --card: #101827;
  --border: #233046;
  --text: #E8EEF7;
  --text2: #A9B6CC;
  --text3: #7F8CA6;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

[data-theme="light"] {
  --bg0: #F7F8FA;
  --bg1: #F0F2F5;
  --bg2: #E8ECF2;
  --card: #FFFFFF;
  --border: #D9E0EA;
  --text: #101828;
  --text2: #344054;
  --text3: #667085;
  --shadow: 0 12px 28px rgba(16,24,40,.12);
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  font-family: var(--font-ui);
  color: var(--text);
  background: radial-gradient(1200px 700px at 10% -10%, rgba(47,209,200,.18), transparent 55%),
              radial-gradient(900px 600px at 110% 10%, rgba(185,107,255,.18), transparent 55%),
              linear-gradient(180deg, var(--bg0), var(--bg1));
}
a { color: inherit; text-decoration: none; }
button, input { font-family: inherit; }

.container { width: min(1240px, calc(100% - 2*var(--xl))); margin: 0 auto; }
.row { display: flex; gap: var(--lg); }
.col { display: flex; flex-direction: column; gap: var(--lg); }

.card {
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
  border: 1px solid color-mix(in oklab, var(--border) 80%, transparent);
  border-radius: var(--radius-card);
  box-shadow: var(--shadow);
}
.card.pad { padding: var(--lg); }
.muted { color: var(--text2); }
.meta { font-size: 12px; color: var(--text3); }
.label {
  font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color: var(--text3);
}
.kbd {
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 8px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 70%, transparent);
}

.btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 10px;
  padding: 10px 14px;
  border-radius: var(--radius-button);
  border: 1px solid transparent;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: transform .12s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
  user-select: none;
}
.btn:active { transform: translateY(1px); }
.btn.primary {
  background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 92%, white 10%), var(--accent));
  color: #061016;
}
.btn.secondary {
  border-color: color-mix(in oklab, var(--border) 90%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
}
.btn.ghost {
  border-color: transparent;
  background: transparent;
}
.btn.danger {
  background: linear-gradient(180deg, color-mix(in oklab, var(--critical) 92%, white 10%), var(--critical));
  color: #180707;
}
.btn.icon { width: 40px; height: 40px; padding: 0; border-radius: 12px; }
.btn:hover { background: color-mix(in oklab, var(--card) 70%, transparent); border-color: color-mix(in oklab, var(--border) 85%, transparent); }
.btn.primary:hover { filter: saturate(1.05) brightness(1.02); }
.btn.danger:hover { filter: saturate(1.05) brightness(1.02); }

.badge {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 6px 10px;
  border-radius: var(--radius-badge);
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  background: color-mix(in oklab, var(--card) 80%, transparent);
  font-size: 12px;
}
.dot { width: 8px; height: 8px; border-radius: 999px; background: var(--text3); }

.sep { height: 1px; background: color-mix(in oklab, var(--border) 70%, transparent); }

.grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--lg);
}
@media (max-width: 1024px) {
  .container { width: min(1100px, calc(100% - 2*var(--lg))); }
  .grid { grid-template-columns: repeat(8, 1fr); }
}
@media (max-width: 768px) {
  .grid { grid-template-columns: repeat(4, 1fr); }
}

.toast {
  position: fixed; bottom: 18px; right: 18px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  box-shadow: var(--shadow);
  max-width: min(420px, calc(100% - 36px));
  opacity: 0; transform: translateY(10px);
  pointer-events: none;
  transition: opacity .22s ease, transform .22s ease;
}
.toast.show { opacity: 1; transform: translateY(0); }

  
.appShell{
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}
.sidebar{
  position: sticky; top:0; align-self:start;
  height: 100vh;
  padding: var(--lg);
  border-right: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: linear-gradient(180deg, color-mix(in oklab, var(--bg0) 80%, transparent), var(--bg1));
}
.brand{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 10px 14px;
  border-radius: 14px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
}
.wordmark{
  font-weight: 800; letter-spacing: .06em;
  font-size: 14px;
}
.wordmark span{
  background: linear-gradient(90deg, var(--accent), var(--pve));
  -webkit-background-clip:text; background-clip:text; color: transparent;
}
.nav{
  margin-top: var(--lg);
  display:flex; flex-direction:column; gap: 6px;
}
.nav a{
  display:flex; align-items:center; gap: 10px;
  padding: 10px 10px;
  border-radius: 12px;
  color: var(--text2);
  border: 1px solid transparent;
}
.nav a.active{
  color: var(--text);
  background: color-mix(in oklab, var(--card) 75%, transparent);
  border-color: color-mix(in oklab, var(--border) 80%, transparent);
}
.nav a:hover{
  color: var(--text);
  background: color-mix(in oklab, var(--card) 70%, transparent);
}
.nav .sub{ margin-left: 28px; display:flex; flex-direction:column; gap: 6px; }
.smallToggle{
  display:flex; align-items:center; gap: 8px; color: var(--text2);
  margin-top: var(--lg);
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  cursor: pointer;
}
.main{
  padding: var(--xl);
}
.topbar{
  position: sticky; top: 0;
  z-index: 20;
  margin: calc(var(--xl) * -1) calc(var(--xl) * -1) var(--xl);
  padding: var(--lg) var(--xl);
  border-bottom: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--bg0) 78%, transparent);
  backdrop-filter: blur(10px);
}
.topbarRow{
  display:flex; align-items:center; justify-content:space-between; gap: var(--lg);
}
.breadcrumb{
  display:flex; align-items:center; gap: 10px;
  color: var(--text2);
  font-size: 13px;
}
.patient{
  display:flex; align-items:center; gap: 10px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
}
.patient strong{ color: var(--text); font-weight: 650; }
.pip{
  display:flex; align-items:center; gap: 10px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  color: var(--text2);
  font-size: 12px;
}
.pip .dot{ background: var(--stable); box-shadow: 0 0 0 4px color-mix(in oklab, var(--stable) 18%, transparent); }
@media (max-width: 1024px){
  .appShell{ grid-template-columns: 84px 1fr; }
  .sidebar .wordmark, .sidebar .nav span.txt, .sidebar .sub{ display:none; }
  .sidebar{ padding: var(--md); }
  .sidebar .brand{ justify-content:center; padding: 12px; }
  .nav a{ justify-content:center; }
  .smallToggle{ justify-content:center; }
}
@media (max-width: 768px){
  .appShell{ grid-template-columns: 1fr; }
  .sidebar{ display:none; }
  .main{ padding: var(--lg); }
  .topbar{
    margin: calc(var(--lg) * -1) calc(var(--lg) * -1) var(--lg);
    padding: var(--md) var(--lg);
  }
  .breadcrumb{ display:none; }
}

  
.scoreGrid{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--lg);
}
@media (max-width: 1024px){
  .scoreGrid{ grid-template-columns: repeat(8, 1fr); }
}
@media (max-width: 768px){
  .scoreGrid{ grid-template-columns: repeat(4, 1fr); }
}
.scoreCard{
  grid-column: span 4;
  position: relative;
  overflow: hidden;
}
.scoreCard .head{
  display:flex; align-items:baseline; justify-content:space-between; gap: var(--md);
}
.engineTag{
  display:flex; align-items:center; gap: 10px;
}
.enginePill{
  width: 36px; height: 36px; border-radius: 12px;
  display:grid; place-items:center;
  background: color-mix(in oklab, var(--accent) 18%, transparent);
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
}
.engineName{
  font-weight: 750; letter-spacing: .10em; text-transform: uppercase; font-size: 12px;
}
.scoreBig{
  font-family: var(--font-mono);
  font-weight: 800;
  font-size: 56px;
  line-height: 1;
  letter-spacing: -0.04em;
}
.levelLine{
  display:flex; align-items:center; gap: 10px;
  margin-top: 8px;
}
.levelChip{
  display:inline-flex; align-items:center; gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  letter-spacing: .12em;
  text-transform: uppercase;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
}
.trend{
  font-family: var(--font-mono);
  color: var(--text2);
}
.spark{
  margin-top: var(--md);
  height: 44px;
  border-radius: 12px;
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.spark svg{ width: 100%; height: 100%; }
.scoreCard::before{
  content:'';
  position:absolute; inset: -120px -120px auto auto;
  width: 220px; height: 220px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), transparent 60%);
  transform: rotate(12deg);
}
.tone-critical{ --tone: var(--critical); }
.tone-severe{ --tone: var(--severe); }
.tone-moderate{ --tone: var(--moderate); }
.tone-mild{ --tone: var(--mild); }
.tone-stable{ --tone: var(--stable); }

.scoreCard .toneFrame{
  border: 1px solid color-mix(in oklab, var(--tone) 55%, var(--border));
  background:
    radial-gradient(700px 260px at 10% 0%, color-mix(in oklab, var(--tone) 20%, transparent), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
}
.levelChip.tone{
  background: color-mix(in oklab, var(--tone) 16%, transparent);
  border-color: color-mix(in oklab, var(--tone) 55%, var(--border));
  color: color-mix(in oklab, var(--tone) 70%, var(--text));
}
.pulseOnce{
  animation: pulseOnce 0.6s ease-out 1;
}
@keyframes pulseOnce{
  0% { box-shadow: 0 0 0 0 color-mix(in oklab, var(--tone) 24%, transparent); }
  70% { box-shadow: 0 0 0 10px color-mix(in oklab, var(--tone) 0%, transparent); }
  100% { box-shadow: 0 0 0 0 color-mix(in oklab, var(--tone) 0%, transparent); }
}

  
.viewTabs{
  display:flex; gap: 8px; flex-wrap: wrap;
}
.tab{
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  color: var(--text2);
  cursor:pointer;
  font-size: 13px;
}
.tab.active{ color: var(--text); border-color: color-mix(in oklab, var(--accent) 50%, var(--border)); }
.cockpitGrid{
  display:grid; grid-template-columns: repeat(12,1fr); gap: var(--lg);
}
.block{ grid-column: span 12; }
.block6{ grid-column: span 6; }
.block5{ grid-column: span 5; }
.block7{ grid-column: span 7; }
.block4{ grid-column: span 4; }
@media (max-width: 1024px){
  .block6,.block5,.block7,.block4{ grid-column: span 8; }
}
@media (max-width: 768px){
  .block6,.block5,.block7,.block4{ grid-column: span 4; }
}
.alertStack{ display:flex; flex-direction:column; gap: var(--sm); }
.alertCard{
  padding: 14px;
  border-radius: 14px;
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  display:flex; gap: 12px; align-items:flex-start;
}
.alertIcon{
  width: 40px; height: 40px; border-radius: 14px;
  display:grid; place-items:center;
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
}
.alertBody{ flex:1; }
.alertTitle{ font-weight: 700; }
.alertMeta{ margin-top: 6px; display:flex; gap: 10px; flex-wrap:wrap; align-items:center; color: var(--text3); font-size: 12px; }
.alertAction{ margin-top: 10px; display:flex; gap: 10px; flex-wrap:wrap; }
.alert-critical{ --a: var(--critical); }
.alert-warning{ --a: var(--severe); }
.alert-info{ --a: var(--mild); }
.alert-critical .alertIcon{ background: color-mix(in oklab, var(--critical) 20%, transparent); color: color-mix(in oklab, var(--critical) 70%, var(--text)); border-color: color-mix(in oklab, var(--critical) 50%, var(--border)); }
.alert-warning .alertIcon{ background: color-mix(in oklab, var(--severe) 18%, transparent); color: color-mix(in oklab, var(--severe) 70%, var(--text)); border-color: color-mix(in oklab, var(--severe) 45%, var(--border)); }
.alert-info .alertIcon{ background: color-mix(in oklab, var(--mild) 18%, transparent); color: color-mix(in oklab, var(--mild) 70%, var(--text)); border-color: color-mix(in oklab, var(--mild) 45%, var(--border)); }

.timeline{
  padding: 14px;
  overflow:auto;
}
.tRow{
  display:flex; gap: 10px; min-width: 720px;
}
.day{
  width: 120px;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
}
.day .d{ font-family: var(--font-mono); font-weight: 800; }
.event{ margin-top: 8px; font-size: 12px; color: var(--text2); line-height: 1.35; }
.pill{
  margin-top: 10px;
  display:inline-flex; align-items:center; gap: 8px;
  padding: 6px 10px; border-radius: 999px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  font-size: 12px;
}
.layerGrid{
  display:grid; grid-template-columns: repeat(12,1fr); gap: var(--lg);
}
.layer{ grid-column: span 6; }
@media (max-width: 1024px){ .layer{ grid-column: span 8; } }
@media (max-width: 768px){ .layer{ grid-column: span 4; } }
.sf{
  padding: 14px;
  border-radius: 14px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
}
.sfHead{ display:flex; justify-content:space-between; gap: 12px; }
.bar{
  height: 10px;
  border-radius: 999px;
  background: color-mix(in oklab, var(--bg2) 65%, transparent);
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  overflow:hidden;
  margin-top: 10px;
}
.bar > i{
  display:block; height:100%;
  width: 50%;
  background: linear-gradient(90deg, color-mix(in oklab, var(--tone) 70%, white 10%), var(--tone));
}
.sigList{ margin-top: 10px; display:none; flex-direction:column; gap: 8px; }
.sf.open .sigList{ display:flex; }
.sig{
  display:flex; align-items:center; justify-content:space-between; gap: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  background: color-mix(in oklab, var(--card) 88%, transparent);
  font-size: 13px;
}
.sig .k{ color: var(--text2); }
.sig .v{ font-family: var(--font-mono); font-weight: 700; }
.patterns{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.pBadge{
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
  font-size: 12px;
}
.pBadge strong{ font-family: var(--font-mono); }
.rule{
  padding: 14px;
  border-radius: 14px;
  border: 1px solid color-mix(in oklab, var(--border) 75%, transparent);
  background: color-mix(in oklab, var(--card) 85%, transparent);
}
.ruleHead{ display:flex; align-items:center; justify-content:space-between; gap: 12px; }
.ruleType{
  display:inline-flex; align-items:center; gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  background: color-mix(in oklab, var(--bg2) 65%, transparent);
  border: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
  font-size: 12px; color: var(--text2);
}

  </style>
</head>
<body>
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div class="appShell">
  <aside class="sidebar">
    <div class="brand" title="PULSAR"><div class="wordmark"><span>PULSAR</span></div><span class="badge" style="padding:6px 10px;"><span class="dot" style="background:var(--accent)"></span>V14</span></div>
    <nav class="nav" aria-label="Navigation">
      <a class="active" href="#" data-nav="cockpit"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 13a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/><path d="M12 13l3-3"/></svg><span class="txt">Cockpit</span></a>
      <a href="#" data-nav="vps"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span class="txt">VPS</span></a>
      <a href="#" data-nav="tde"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg><span class="txt">TDE</span></a>
      <a href="#" data-nav="pve"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg><span class="txt">PVE</span></a>
      <a href="#" data-nav="tests"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12"/><path d="M8 2v6l-4.5 8.5A3 3 0 0 0 6.1 21h11.8a3 3 0 0 0 2.6-4.5L16 8V2"/></svg><span class="txt">Crash Tests</span></a>
      <div class="sep" style="margin:10px 0;"></div>
    </nav>
    <div class="smallToggle" onclick="toggleTheme()"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg><span class="txt">ThÃ¨me Â· <span id="themeLabel">Dark</span></span></div>
  </aside>
  <main class="main">
    <header class="topbar"><div class="topbarRow">
      <div class="breadcrumb"><span id="breadcrumb">Cockpit</span></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <div class="pip"><span class="dot"></span><span id="lastRun">â€”</span></div>
        <div class="patient"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><div><div><strong id="patientName">â€”</strong></div><div class="meta" id="patientMeta">â€”</div></div></div>
        <select id="scenarioSelect" style="font-family:var(--font-ui);font-size:13px;padding:8px 12px;border-radius:var(--radius-button);border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;" onchange="switchScenario(this.value)">
          <option value="FIRES">FIRES typique</option><option value="NMDAR">Anti-NMDAR</option><option value="CYTOKINE">Orage cytokinique</option><option value="REBOND">Rebond J5</option><option value="STABLE">Stable (contrÃ´le âˆ’)</option>
        </select>
        <button class="btn secondary" onclick="toggleTheme()"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg></button>
      </div>
    </div></header>
    <div class="viewTabs" style="margin-bottom:var(--lg);"><button class="tab active" data-view="cockpit" onclick="showView('cockpit')">Cockpit</button><button class="tab" data-view="vps" onclick="showView('vps')">VPS</button><button class="tab" data-view="tde" onclick="showView('tde')">TDE</button><button class="tab" data-view="pve" onclick="showView('pve')">PVE</button><button class="tab" data-view="tests" onclick="showView('tests')">Crash Tests</button></div>

    <!-- COCKPIT -->
    <section class="view" id="view-cockpit">
      <div class="scoreGrid">
        <div id="cardVPS" class="scoreCard card tone-stable" data-scorejump="vps"><div class="toneFrame card pad"><div class="head"><div class="engineTag"><div class="enginePill" style="color:var(--vps)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><div><div class="engineName">VPS</div><div class="meta">Pronostic vital</div></div></div></div><div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-top:12px;"><div class="scoreBig" id="vpsScore">0</div><div class="trend" id="vpsTrend">â€”</div></div><div class="levelLine"><span class="levelChip tone" id="vpsLevel">â€”</span></div><div class="spark" id="vpsSpark"></div></div></div>
        <div id="cardTDE" class="scoreCard card tone-stable" data-scorejump="tde"><div class="toneFrame card pad"><div class="head"><div class="engineTag"><div class="enginePill" style="color:var(--tde)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></div><div><div class="engineName">TDE</div><div class="meta">DÃ©cision thÃ©rapeutique</div></div></div></div><div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-top:12px;"><div class="scoreBig" id="tdeScore">0</div><div class="trend" id="tdeTrend">â€”</div></div><div class="levelLine"><span class="levelChip tone" id="tdeLevel">â€”</span></div><div class="spark" id="tdeSpark"></div></div></div>
        <div id="cardPVE" class="scoreCard card tone-stable" data-scorejump="pve"><div class="toneFrame card pad"><div class="head"><div class="engineTag"><div class="enginePill" style="color:var(--pve)"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg></div><div><div class="engineName">PVE</div><div class="meta">Pharmacovigilance</div></div></div></div><div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-top:12px;"><div class="scoreBig" id="pveScore">0</div><div class="trend" id="pveTrend">â€”</div></div><div class="levelLine"><span class="levelChip tone" id="pveLevel">â€”</span></div><div class="spark" id="pveSpark"></div></div></div>
      </div>
      <div class="cockpitGrid" style="margin-top:var(--lg);">
        <div class="block7"><div class="card pad">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;"><div><div class="label">Alertes actives</div><div style="margin-top:6px;font-weight:750;font-size:18px;">Ce qui peut changer la dÃ©cision maintenant</div></div><span class="badge" id="alertCount">â€”</span></div>
          <div class="alertStack" id="alertsContainer" style="margin-top:var(--md);"></div>
          <div class="sep" style="margin:var(--lg) 0;"></div>
          <div class="label">Recommandations</div>
          <div id="recoContainer" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;"></div>
        </div></div>
        <div class="block5"><div class="card pad">
          <div class="label">Timeline patient Â· GCS</div>
          <div class="timeline" style="margin-top:var(--md);"><div class="tRow" id="timelineRow"></div></div>
        </div></div>
      </div>
    </section>

    <!-- ENGINE VIEWS -->
    <section class="view" id="view-vps" style="display:none;">
      <div class="card pad" style="margin-bottom:var(--lg);"><div class="label">Moteur VPS Â· vue dÃ©taillÃ©e</div><div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:6px;"><div style="font-weight:800;font-size:22px;">Intention â†’ Contexte â†’ RÃ¨gles â†’ Courbe</div><span class="badge"><span class="dot" style="background:var(--vps)"></span>Score <strong id="vpsScoreDetail">â€”</strong></span></div></div>
      <div class="layerGrid">
        <div class="layer"><div class="card pad"><div class="label">Intention Â· champs sÃ©mantiques</div><div id="vpsFields" style="margin-top:var(--md);display:flex;flex-direction:column;gap:var(--sm);"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">Contexte Â· modificateurs &amp; patterns</div><div id="vpsContext" class="muted" style="margin-top:10px;line-height:1.6;"></div><div class="patterns" id="vpsPatterns"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">RÃ¨gles Â· garde-fous</div><div id="vpsRules" style="margin-top:var(--md);display:flex;flex-direction:column;gap:var(--sm);"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">Courbe Â· trajectoire</div><div id="vpsCurve" style="margin-top:var(--md);"></div></div></div>
      </div>
    </section>
    <section class="view" id="view-tde" style="display:none;">
      <div class="card pad" style="margin-bottom:var(--lg);"><div class="label">Moteur TDE Â· vue dÃ©taillÃ©e</div><div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:6px;"><div style="font-weight:800;font-size:22px;">Recommandations Â· Escalade thÃ©rapeutique</div><span class="badge"><span class="dot" style="background:var(--tde)"></span>Score <strong id="tdeScoreDetail">â€”</strong></span></div></div>
      <div class="layerGrid">
        <div class="layer"><div class="card pad"><div class="label">Intention Â· axes</div><div id="tdeFields" style="margin-top:var(--md);display:flex;flex-direction:column;gap:var(--sm);"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">Contexte &amp; patterns</div><div id="tdeContext" class="muted" style="margin-top:10px;line-height:1.6;"></div><div class="patterns" id="tdePatterns"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">RÃ¨gles</div><div id="tdeRules" style="margin-top:var(--md);display:flex;flex-direction:column;gap:var(--sm);"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">Courbe</div><div id="tdeCurve" style="margin-top:var(--md);"></div></div></div>
      </div>
    </section>
    <section class="view" id="view-pve" style="display:none;">
      <div class="card pad" style="margin-bottom:var(--lg);"><div class="label">Moteur PVE Â· vue dÃ©taillÃ©e</div><div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:6px;"><div style="font-weight:800;font-size:22px;">Pharmacovigilance Â· interactions</div><span class="badge"><span class="dot" style="background:var(--pve)"></span>Score <strong id="pveScoreDetail">â€”</strong></span></div></div>
      <div class="layerGrid">
        <div class="layer"><div class="card pad"><div class="label">Intention Â· familles</div><div id="pveFields" style="margin-top:var(--md);display:flex;flex-direction:column;gap:var(--sm);"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">Contexte &amp; patterns</div><div id="pveContext" class="muted" style="margin-top:10px;line-height:1.6;"></div><div class="patterns" id="pvePatterns"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">RÃ¨gles</div><div id="pveRules" style="margin-top:var(--md);display:flex;flex-direction:column;gap:var(--sm);"></div></div></div>
        <div class="layer"><div class="card pad"><div class="label">Courbe</div><div id="pveCurve" style="margin-top:var(--md);"></div></div></div>
      </div>
    </section>
    <section class="view" id="view-tests" style="display:none;">
      <div class="card pad" style="margin-bottom:var(--lg);"><div style="display:flex;align-items:center;justify-content:space-between;gap:12px;"><div><div class="label">Validation Â· 5 scÃ©narios</div><div style="font-weight:800;font-size:22px;margin-top:6px;">Crash Tests V13 â€” Moteurs rÃ©els</div></div><button class="btn primary" onclick="runCrashTests()">ExÃ©cuter tous les tests</button></div></div>
      <div id="crashResults"></div>
      <div class="card pad" id="crashSummary" style="margin-top:var(--lg);display:none;"><div style="display:flex;align-items:center;justify-content:space-between;"><div style="font-weight:800;font-size:22px;" id="crashTotal">â€”</div><div id="crashStatus" class="badge">â€”</div></div></div>
    </section>
    <div class="meta" style="margin-top:var(--xl);">PULSAR V14 Â· Moteurs V13 intÃ©grÃ©s Â· 33 crash tests Â· Dark/Light Â· Â© 2026</div>
  </main>
</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}

function setTheme(t){document.documentElement.setAttribute('data-theme',t);try{localStorage.setItem('pulsar_theme',t)}catch(e){}const l=$('#themeLabel');if(l)l.textContent=t==='dark'?'Dark':'Light';}
function toggleTheme(){setTheme((document.documentElement.getAttribute('data-theme')||'dark')==='dark'?'light':'dark');}
function initTheme(){try{setTheme(localStorage.getItem('pulsar_theme')||'dark')}catch(e){setTheme('dark')}}

function toast(msg){const el=$('#toast');if(!el)return;el.textContent=msg;el.classList.add('show');clearTimeout(window.__tt);window.__tt=setTimeout(()=>el.classList.remove('show'),2400);}

function animateNumber(el,to,ms){
  ms=ms||500;
  const from=parseFloat(el.textContent.replace(/[^\d.\-]/g,''))||0;
  const start=performance.now();
  function tick(now){
    const p=clamp((now-start)/ms,0,1);
    const e=1-Math.pow(1-p,3);
    el.textContent=Math.round(from+(to-from)*e);
    if(p<1)requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

function levelFromScore(s){
  if(s>=70)return{key:'CRITIQUE',tone:'critical'};
  if(s>=50)return{key:'SÃ‰VÃˆRE',tone:'severe'};
  if(s>=30)return{key:'MODÃ‰RÃ‰',tone:'moderate'};
  if(s>=15)return{key:'LÃ‰GER',tone:'mild'};
  return{key:'STABLE',tone:'stable'};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// V13 BRAIN ENGINES â€” injected below
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</script>
<script>
// PULSAR V13 â€” Brain Engines (VPS + TDE + PVE) + 32 Crash Tests
// Architecture: 3 moteurs Ã— 4 couches
// 32/32 tests validÃ©s

// Extract and run the PULSAR V13 engines + crash tests in Node.js

// â•â•â• PATIENT STATE â•â•â•
class PatientState {
  constructor(d) {
    this.ageMonths = d.ageMonths; this.weightKg = d.weightKg; this.hospDay = d.hospDay;
    this.neuro = { gcs: d.gcs, gcsHistory: d.gcsHistory || [], pupils: d.pupils, seizures24h: d.seizures24h, seizureDuration: d.seizureDuration, seizureType: d.seizureType };
    this.biology = { crp: d.crp, pct: d.pct, ferritin: d.ferritin, wbc: d.wbc, platelets: d.platelets, lactate: d.lactate };
    this.hemodynamics = { heartRate: d.heartRate, sbp: d.sbp, dbp: d.dbp, map: Math.round(d.dbp + (d.sbp - d.dbp) / 3), spo2: d.spo2, temp: d.temp, respRate: d.respRate };
    this.csf = { cells: d.csfCells, protein: d.csfProtein, antibodies: d.csfAntibodies };
    this.drugs = d.drugs || []; this.treatmentHistory = d.treatmentHistory || [];
    this.vpsResult = null; this.tdeResult = null; this.pveResult = null;
    this.alerts = []; this.recommendations = [];
  }
  getAgeGroup() {
    if (this.ageMonths < 1) return 'neonate'; if (this.ageMonths < 12) return 'infant';
    if (this.ageMonths < 60) return 'toddler'; if (this.ageMonths < 144) return 'child'; return 'adolescent';
  }
  getNormalRanges() {
    const r = {
      neonate:{ hrLow:100,hrHigh:170,sbpLow:60,sbpHigh:90,mapLow:40 },
      infant:{ hrLow:100,hrHigh:160,sbpLow:70,sbpHigh:100,mapLow:45 },
      toddler:{ hrLow:80,hrHigh:140,sbpLow:75,sbpHigh:110,mapLow:50 },
      child:{ hrLow:70,hrHigh:120,sbpLow:80,sbpHigh:120,mapLow:55 },
      adolescent:{ hrLow:60,hrHigh:100,sbpLow:90,sbpHigh:130,mapLow:60 }
    };
    return r[this.getAgeGroup()];
  }
}

// â•â•â• SEMANTIC FIELD â•â•â•
class SemanticField {
  constructor({ name, category, color, signals }) {
    this.name = name; this.category = category; this.color = color; this.signals = signals;
  }
  computeIntensity(ps) {
    let tw = 0, ws = 0;
    this.signals.forEach(s => { const r = s.extract(ps); if (r == null) return; const n = s.normalize(r, ps); const w = s.weight || 1; ws += n * w; tw += w; });
    return tw === 0 ? 0 : Math.min(100, Math.round(ws / tw));
  }
  getSignalDetails(ps) {
    return this.signals.map(s => { const r = s.extract(ps); const n = r != null ? s.normalize(r, ps) : 0; return { name: s.name, rawValue: r, normalized: n, unit: s.unit || '', status: n > 75 ? 'critical' : n > 50 ? 'warning' : n > 25 ? 'moderate' : 'normal' }; });
  }
  interpret(i) { if (i >= 80) return 'DÃ©faillance sÃ©vÃ¨re'; if (i >= 60) return 'Atteinte significative'; if (i >= 40) return 'Atteinte modÃ©rÃ©e'; if (i >= 20) return 'Atteinte lÃ©gÃ¨re'; return 'Normal'; }
}

// â•â•â• BRAIN CORE â•â•â•
class BrainCore {
  constructor(name) { this.name = name; this.semanticFields = []; this.patterns = []; this.rules = []; }
  analyzeIntention(ps) {
    const fields = this.semanticFields.map(f => ({ name: f.name, category: f.category, intensity: f.computeIntensity(ps), signals: f.getSignalDetails(ps), color: f.color, interpretation: f.interpret(f.computeIntensity(ps)) }));
    const patterns = []; this.patterns.forEach(p => { const m = p.match(ps, fields); if (m.confidence > 0.4) patterns.push({ name: p.name, confidence: m.confidence, description: m.description, implications: m.implications }); });
    return { fields, patterns: patterns.sort((a, b) => b.confidence - a.confidence) };
  }
  analyzeContext(ps, ir) { return { trend: 'stable', details: [], contextModifier: 1.0 }; }
  applyRules(ps, ir, cr) {
    const applied = [];
    this.rules.forEach(r => { const res = r.evaluate(ps, ir, cr); if (res.triggered) applied.push({ name: r.name, type: res.type, message: res.message, reference: r.reference, adjustment: res.adjustment || null }); });
    return applied;
  }
  computeCurve(ps, ir, cr) { return { trajectory: [], currentPosition: 0, currentValue: 0, trend: 'stable', curveData: [], labels: [] }; }
  run(ps) {
    const intention = this.analyzeIntention(ps);
    const context = this.analyzeContext(ps, intention);
    const rules = this.applyRules(ps, intention, context);
    const curve = this.computeCurve(ps, intention, context);
    const synthesis = this.synthesize(ps, intention, context, rules, curve);
    return { engine: this.name, intention, context, rules, curve, synthesis };
  }
  synthesize() { return { score: 0, level: 'unknown', alerts: [], recommendations: [] }; }
}

// â•â•â• VPS ENGINE â•â•â•
class VPSEngine extends BrainCore {
  constructor() {
    super('VPS');
    this.semanticFields.push(new SemanticField({
      name: 'DÃ©faillance neurologique', category: 'neuro', color: 'red',
      signals: [
        { name: 'GCS', extract: ps => ps.neuro.gcs, normalize: v => Math.round(((15-v)/12)*100), weight: 3 },
        { name: 'Pupilles', extract: ps => ps.neuro.pupils, normalize: v => ({reactive:0,sluggish:30,fixed_one:70,fixed_both:100}[v]||0), weight: 2.5 },
        { name: 'Crises/24h', extract: ps => ps.neuro.seizures24h, normalize: v => Math.min(100,v*12), weight: 2 },
        { name: 'DurÃ©e crises', extract: ps => ps.neuro.seizureDuration, normalize: v => v>=30?100:v>=15?80:v>=5?50:v>=2?25:0, weight: 2 },
        { name: 'Type crises', extract: ps => ps.neuro.seizureType, normalize: v => ({none:0,focal_aware:15,focal_impaired:35,generalized_tonic_clonic:55,status:80,refractory_status:95,super_refractory:100}[v]||0), weight: 2.5 }
      ]
    }));
    this.semanticFields.push(new SemanticField({
      name: 'Orage inflammatoire', category: 'inflammatory', color: 'amber',
      signals: [
        { name: 'CRP', extract: ps => ps.biology.crp, normalize: v => v>=200?100:v>=100?75:v>=50?50:v>=20?30:v>=5?10:0, weight: 1.5 },
        { name: 'PCT', extract: ps => ps.biology.pct, normalize: v => v>=10?100:v>=2?75:v>=0.5?50:v>=0.25?25:0, weight: 2 },
        { name: 'Ferritine', extract: ps => ps.biology.ferritin, normalize: v => v>=10000?100:v>=5000?85:v>=1000?65:v>=500?40:v>=200?15:0, weight: 1.5 },
        { name: 'Leucocytes', extract: ps => ps.biology.wbc, normalize: v => (v>30||v<2)?80:(v>20||v<4)?50:(v>15||v<5)?25:0, weight: 1 },
        { name: 'Temp', extract: ps => ps.hemodynamics.temp, normalize: v => v>=40?90:v>=39?60:v>=38.5?35:v>=38?15:v<35?70:0, weight: 1 }
      ]
    }));
    this.semanticFields.push(new SemanticField({
      name: 'DÃ©faillance hÃ©modynamique', category: 'hemodynamic', color: 'purple',
      signals: [
        { name: 'FC', extract: ps => ps.hemodynamics.heartRate, normalize: (v,ps) => { const r=ps.getNormalRanges(); return (v>r.hrHigh+40||v<r.hrLow-30)?90:(v>r.hrHigh+20||v<r.hrLow-15)?60:(v>r.hrHigh||v<r.hrLow)?30:0; }, weight: 1.5 },
        { name: 'PAM', extract: ps => ps.hemodynamics.map, normalize: (v,ps) => { const r=ps.getNormalRanges(); return v<r.mapLow-15?100:v<r.mapLow-10?75:v<r.mapLow?45:0; }, weight: 2.5 },
        { name: 'Lactates', extract: ps => ps.biology.lactate, normalize: v => v>=8?100:v>=4?75:v>=2?40:v>=1?10:0, weight: 2 },
        { name: 'SpO2', extract: ps => ps.hemodynamics.spo2, normalize: v => v<85?100:v<90?75:v<92?50:v<95?20:0, weight: 2 },
        { name: 'Plaquettes', extract: ps => ps.biology.platelets, normalize: v => v<20?100:v<50?75:v<100?40:v<150?15:0, weight: 1.5 }
      ]
    }));
    this.patterns.push({ name: 'DÃ©tÃ©rioration neurologique progressive', match: ps => { const h=ps.neuro.gcsHistory,c=ps.neuro.gcs; if(h.length<2) return{confidence:0}; const drop=(h[0]||15)-c; if(h.every((v,i)=>i===0||v<=h[i-1])&&drop>=3) return{confidence:Math.min(1,drop/8),description:`GCS: ${h.join('â†’')}â†’${c}`,implications:'DÃ©tÃ©rioration continue'}; return{confidence:0}; }});
    this.patterns.push({ name: 'Rebond post-amÃ©lioration', match: ps => { const h=ps.neuro.gcsHistory,c=ps.neuro.gcs; if(h.length<2) return{confidence:0}; if(h[h.length-1]>h[h.length-2]&&c<h[h.length-1]) return{confidence:0.85,description:`${h[h.length-2]}â†’${h[h.length-1]}â†’${c}`,implications:'Rebond â€” suspecter complication'}; return{confidence:0}; }});
    this.patterns.push({ name: 'Orage cytokinique', match: ps => { let m=0; if(ps.biology.ferritin>500)m++; if(ps.biology.ferritin>1000)m++; if(ps.biology.crp>100)m++; if(ps.biology.pct>2)m++; if(ps.hemodynamics.temp>=39)m++; if(ps.biology.wbc>20||ps.biology.wbc<4)m++; if(ps.biology.lactate>4)m++; if(m>=3) return{confidence:Math.min(1,m/5),description:`${m} marqueurs orage`,implications:'ConsidÃ©rer MAS'}; return{confidence:0}; }});
    this.patterns.push({ name: 'Dissociation neuro-inflammatoire', match: (ps,fields) => { const n=fields.find(f=>f.category==='neuro'),i=fields.find(f=>f.category==='inflammatory'); if(!n||!i) return{confidence:0}; if(n.intensity>50&&i.intensity<25) return{confidence:0.75,description:`Neuro ${n.intensity} vs Inflam ${i.intensity}`,implications:'Auto-immun probable'}; return{confidence:0}; }});
    this.rules.push({ name: 'pSOFA Neurologique', reference: 'Matics 2017', evaluate: ps => { const g=ps.neuro.gcs; let s=g<7?4:g<10?3:g<13?2:g<15?1:0; return{triggered:true,type:'validation',message:`pSOFA neuro: ${s}/4 (GCS ${g})`,adjustment:{psofa_neuro:s}}; }});
    this.rules.push({ name: 'Classification ILAE', reference: 'Trinka 2015', evaluate: ps => { const d=ps.neuro.seizureDuration,t=ps.neuro.seizureType; if(t==='status'||t==='refractory_status'||t==='super_refractory'||d>=5){ const l=d>=60||t==='super_refractory'?'Super-rÃ©fractaire':d>=30||t==='refractory_status'?'RÃ©fractaire':'Ã‰tat de mal'; return{triggered:true,type:'guard',message:`ILAE: ${l}`}; } return{triggered:false}; }});
    this.rules.push({ name: 'CritÃ¨res de Graus', reference: 'Graus 2016', evaluate: ps => { let c=0,d=[]; if(ps.neuro.gcs<14){c++;d.push('conscience');} if(ps.neuro.seizures24h>0){c++;d.push('crises');} if(ps.csf.cells>5){c++;d.push('plÃ©iocytose');} if(ps.csf.protein>0.45){c++;d.push('protÃ©inorachie');} if(ps.csf.antibodies!=='negative'&&ps.csf.antibodies!=='pending'){c++;d.push(`Ac+`);} if(ps.hemodynamics.temp>=38){c++;d.push('fiÃ¨vre');} if(c>=3) return{triggered:true,type:'guard',message:`${c}/6 Graus: ${d.join(', ')}`}; return{triggered:false}; }});
    this.rules.push({ name: 'mRS pÃ©diatrique', reference: 'Beslow 2012', evaluate: ps => { let m=ps.neuro.gcs<=4?5:ps.neuro.gcs<=8?4:ps.neuro.gcs<=11||ps.neuro.pupils==='fixed_one'?3:ps.neuro.gcs<=13?2:ps.neuro.gcs<=14?1:0; return{triggered:true,type:'validation',message:`mRS: ${m}/5`}; }});
  }
  analyzeContext(ps, ir) {
    const h=ps.neuro.gcsHistory,c=ps.neuro.gcs,det=[]; let cm=1.0;
    if(h.length>=2){ const prev=h[h.length-1],pp=h.length>=2?h[h.length-2]:prev;
      if(c<prev&&prev<pp){det.push({type:'deterioration',label:'DÃ©tÃ©rioration continue',detail:`GCS ${pp}â†’${prev}â†’${c}`,icon:'ğŸ“‰'});cm=1.3;}
      else if(c<prev&&prev>=pp){det.push({type:'rebond',label:'Rebond',detail:`${pp}â†’${prev}â†’${c}`,icon:'â†—ï¸â†˜ï¸'});cm=1.4;}
      else if(c>prev){det.push({type:'improvement',label:'AmÃ©lioration',detail:`GCS ${prev}â†’${c}`,icon:'ğŸ“ˆ'});cm=0.85;}
      else{det.push({type:'stable',label:'Stable',detail:`GCS ${c}`,icon:'â¡ï¸'});}
    }
    if(ps.hospDay>=5&&c<=10){det.push({type:'prolonged',label:'ProlongÃ©',detail:`J${ps.hospDay}`,icon:'â³'});cm=Math.max(cm,1.2);}
    return{trend:det[0]?.type||'stable',details:det,contextModifier:cm};
  }
  computeCurve(ps,ir){
    const h=ps.neuro.gcsHistory.map(g=>Math.round(((15-g)/12)*100)),c=Math.round(((15-ps.neuro.gcs)/12)*100),full=[...h,c];
    const gi=ir.fields.reduce((s,f)=>s+f.intensity,0)/ir.fields.length;
    const td=full.length>=2?full[full.length-1]-full[full.length-2]:0;
    return{trajectory:full,currentPosition:full.length-1,currentValue:c,globalIntensity:Math.round(gi),trend:td>5?'worsening':td<-5?'improving':'stable',curveData:full,labels:full.map((_,i)=>`J${ps.hospDay-full.length+1+i}`)};
  }
  synthesize(ps,intention,context,rules,curve){
    const w={neuro:3,inflammatory:1.5,hemodynamic:2}; let raw=0,tw=0;
    intention.fields.forEach(f=>{const wt=w[f.category]||1;raw+=f.intensity*wt;tw+=wt;}); raw/=tw; raw*=context.contextModifier;
    intention.patterns.forEach(p=>{raw+=p.confidence*12;}); const score=Math.min(100,Math.round(raw));
    let level; if(score>=70) level='CRITIQUE'; else if(score>=50) level='SÃ‰VÃˆRE'; else if(score>=40) level='MODÃ‰RÃ‰'; else if(score>=15) level='LÃ‰GER'; else level='STABLE';
    const alerts=[];
    if(score>=70) alerts.push({severity:'critical',title:'ALERTE VPS CRITIQUE',body:`Score ${score}/100`,source:'VPS'});
    intention.patterns.filter(p=>p.confidence>0.6).forEach(p=>alerts.push({severity:p.confidence>0.8?'critical':'warning',title:p.name,body:p.description,source:'VPS Patterns'}));
    return{score,level,levelColor:'',alerts,recommendations:[]};
  }
}

// â•â•â• TDE ENGINE â•â•â•
class TDEEngine extends BrainCore {
  constructor(){
    super('TDE');
    this.semanticFields.push(new SemanticField({
      name:'Tableau syndromique',category:'syndromic',color:'blue',
      signals:[
        {name:'Crises',extract:ps=>ps.neuro.seizureType,normalize:v=>({none:0,focal_aware:10,focal_impaired:25,generalized_tonic_clonic:40,status:65,refractory_status:85,super_refractory:100}[v]||0),weight:3},
        {name:'EncÃ©phalopathie',extract:ps=>ps.neuro.gcs,normalize:v=>Math.round(((15-v)/12)*100),weight:2},
        {name:'PlÃ©iocytose',extract:ps=>ps.csf.cells,normalize:v=>v>500?100:v>100?75:v>30?50:v>5?25:0,weight:2},
        {name:'FiÃ¨vre',extract:ps=>ps.hemodynamics.temp,normalize:v=>v>=38?Math.min(100,(v-37)*40):0,weight:1},
        {name:'Anticorps',extract:ps=>ps.csf.antibodies,normalize:v=>v==='negative'?30:v==='pending'?50:90,weight:1.5}
      ]
    }));
    this.semanticFields.push(new SemanticField({
      name:'RÃ©ponse thÃ©rapeutique',category:'response',color:'green',
      signals:[
        {name:'Ã‰checs',extract:ps=>ps.treatmentHistory.filter(t=>t.response==='none').length,normalize:v=>Math.min(100,v*35),weight:3},
        {name:'Partiels',extract:ps=>ps.treatmentHistory.filter(t=>t.response==='partial').length,normalize:v=>Math.min(80,v*25),weight:1.5},
        {name:'DurÃ©e',extract:ps=>ps.hospDay,normalize:v=>Math.min(100,v*10),weight:2}
      ]
    }));
    this.patterns.push({name:'Pattern FIRES',match:ps=>{let m=0;if(ps.neuro.seizureType==='refractory_status'||ps.neuro.seizureType==='super_refractory')m+=2;else if(ps.neuro.seizureType==='status')m++;if(ps.hemodynamics.temp>=38)m++;if(ps.csf.cells>5)m++;if(ps.csf.antibodies==='negative'||ps.csf.antibodies==='pending')m++;if(ps.ageMonths>=24&&ps.ageMonths<=144)m++;if(m>=4)return{confidence:Math.min(1,m/5),description:'FIRES pattern dÃ©tectÃ©',implications:'WickstrÃ¶m 2022'};return{confidence:0};}});
    this.patterns.push({name:'Pattern EncÃ©phalite anti-NMDAR',match:ps=>{if(ps.csf.antibodies==='nmdar')return{confidence:0.95,description:'Anti-NMDAR confirmÃ©s',implications:'ImmunothÃ©rapie agressive'};let m=0;if(ps.neuro.gcs<12)m++;if(ps.neuro.seizures24h>2)m++;if(ps.csf.cells>10)m++;if(ps.ageMonths>12)m++;if(m>=3&&ps.csf.antibodies==='pending')return{confidence:0.55,description:'Compatible auto-immun',implications:'Ne pas attendre Ac'};return{confidence:0};}});
    this.patterns.push({name:'Ã‰chec premiÃ¨re ligne',match:ps=>{const f=ps.treatmentHistory.filter(t=>['MÃ©thylprednisolone IV','IVIg'].includes(t.treatment)&&t.response==='none');if(f.length>=1)return{confidence:0.9,description:`${f.length} Ã©chec(s) 1Ã¨re ligne`,implications:'Escalade 2Ã¨me ligne'};return{confidence:0};}});
    this.rules.push({name:'Escalade',reference:'WickstrÃ¶m 2022',evaluate:(ps)=>{const fails=ps.treatmentHistory.filter(t=>t.response==='none'),tried=ps.treatmentHistory.map(t=>t.treatment);const fl=['MÃ©thylprednisolone IV','IVIg'],sl=['Rituximab','Cyclophosphamide','PlasmaphÃ©rÃ¨se'];const flf=fl.some(t=>fails.find(f=>f.treatment===t)),slf=sl.some(t=>fails.find(f=>f.treatment===t));let line=1,msg='';if(slf){line=3;msg='3ÃˆME LIGNE';}else if(flf){line=2;msg='2ÃˆME LIGNE';}else if(tried.length===0){line=1;msg='1ÃˆRE LIGNE â€” initier';}else{msg='1ÃˆRE LIGNE en cours';}return{triggered:true,type:line>=2?'guard':'validation',message:msg,adjustment:{therapeuticLine:line}};}});
    this.rules.push({name:'Doses',reference:'BNFc',evaluate:ps=>{const w=ps.weightKg;return{triggered:true,type:'validation',message:`Doses pour ${w}kg`};}});
    this.rules.push({name:'Ne pas attendre Ac',reference:'Titulaer 2013',evaluate:(ps)=>{if(ps.csf.antibodies==='pending'&&ps.neuro.gcs<12&&ps.neuro.seizures24h>2)return{triggered:true,type:'guard',message:'NE PAS attendre Ac'};return{triggered:false};}});
  }
  analyzeContext(ps,ir){
    const det=[];let cm=1.0;const h=ps.treatmentHistory;
    if(h.length>0){const f=h.filter(t=>t.response==='none');if(f.length>0){det.push({type:'failure',label:`${f.length} Ã©chec(s)`,detail:f.map(x=>x.treatment).join(', '),icon:'âŒ'});cm=1+f.length*0.15;}}
    if(ps.hospDay>5&&ps.neuro.gcs<12){det.push({type:'prolonged',label:'ProlongÃ©',detail:`J${ps.hospDay}`,icon:'â°'});cm=Math.max(cm,1.3);}
    if(ps.vpsResult){const v=ps.vpsResult.synthesis.score;if(v>=80){det.push({type:'high_vps',label:'VPS critique',detail:`${v}/100`,icon:'ğŸ”´'});cm=Math.max(cm,1.4);}}
    return{trend:det[0]?.type||'stable',details:det,contextModifier:cm};
  }
  computeCurve(ps){
    const h=ps.treatmentHistory,cd=[],lb=[],lm={'MÃ©thylprednisolone IV':1,'IVIg':1,'Rituximab':2,'Cyclophosphamide':2,'PlasmaphÃ©rÃ¨se':2,'Tocilizumab':3,'Anakinra':3};
    h.forEach(t=>{cd.push((lm[t.treatment]||1)*33);lb.push(t.treatment.substring(0,8));});
    const fails=h.filter(t=>t.response==='none'),cl=fails.length>=2?3:fails.length>=1?2:1;
    return{trajectory:cd,currentPosition:cd.length,currentValue:cl*33,globalIntensity:cl*33,trend:cl>1?'escalating':'first_line',curveData:cd,labels:lb,therapeuticLine:cl};
  }
  synthesize(ps,intention,context,rules,curve){
    const si=intention.fields.find(f=>f.category==='syndromic')?.intensity||0,ri=intention.fields.find(f=>f.category==='response')?.intensity||0;
    let score=Math.min(100,Math.round((si*0.6+ri*0.4)*context.contextModifier));
    const alerts=[],recs=[],line=curve.therapeuticLine||1,w=ps.weightKg;
    if(line===1&&score>50)recs.push({priority:'urgent',title:'ImmunothÃ©rapie 1Ã¨re ligne',body:`Pour ${w}kg`,reference:'WickstrÃ¶m 2022'});
    else if(line===2)recs.push({priority:'urgent',title:'Escalade 2Ã¨me ligne',body:'Rituximab/Cyclo/PlasmaphÃ©rÃ¨se',reference:'Sheikh 2023'});
    else if(line===3)recs.push({priority:'urgent',title:'3Ã¨me ligne',body:'Tocilizumab/Anakinra',reference:'Gaspard 2015'});
    intention.patterns.filter(p=>p.confidence>0.5).forEach(p=>alerts.push({severity:p.confidence>0.8?'critical':'warning',title:p.name,body:p.description,source:'TDE'}));
    let level;if(score>=80)level='ESCALADE URGENTE';else if(score>=60)level='ESCALADE RECOMMANDÃ‰E';else if(score>=40)level='SURVEILLANCE ACTIVE';else level='MAINTIEN';
    return{score,level,levelColor:'',alerts,recommendations:recs};
  }
}

// â•â•â• PVE ENGINE â•â•â•
class PVEEngine extends BrainCore {
  constructor(){
    super('PVE');
    this.interactions=[
      {drugs:['valproate','mÃ©ropÃ©nÃ¨me'],also:['vpa','dÃ©pakine','mÃ©ronem','carbapÃ©nÃ¨me'],severity:'critical',mechanism:'Chute VPA -80%',action:'Switch LEV'},
      {drugs:['midazolam','fluconazole'],also:['hypnovel','triflucan'],severity:'warning',mechanism:'CYP3A4 inhibition',action:'RÃ©duire midazolam 50%'},
      {drugs:['propofol'],also:['diprivan'],severity:'warning',mechanism:'PRIS >48h',conditionCheck:ps=>ps.drugs.find(d=>d.name.toLowerCase().includes('propofol'))&&ps.hospDay>=2,action:'Surveiller CPK/lactates'},
      {drugs:['cyclophosphamide'],also:['endoxan'],severity:'warning',mechanism:'MyÃ©losuppression',action:'NFS J7-J14'},
      {drugs:['aminoside','vancomycine'],also:['gentamicine','amikacine','tobramycine'],severity:'warning',mechanism:'NÃ©phrotoxicitÃ© additive',action:'Dosage sÃ©rique'}
    ];
    this.semanticFields.push(new SemanticField({name:'Charge mÃ©dicamenteuse',category:'drug_burden',color:'amber',signals:[
      {name:'Nb mÃ©d',extract:ps=>ps.drugs.length,normalize:v=>Math.min(100,v*12),weight:2},
      {name:'Polypharmacie',extract:ps=>ps.drugs.length>=5?1:0,normalize:v=>v*70,weight:1.5},
      {name:'DurÃ©e',extract:ps=>ps.hospDay,normalize:v=>Math.min(100,v*8),weight:1.5}
    ]}));
    this.semanticFields.push(new SemanticField({name:'Risque interaction',category:'interaction_risk',color:'red',signals:[
      {name:'Interactions',extract:ps=>this._countInter(ps),normalize:v=>Math.min(100,v.critical*40+v.warning*20+v.info*5),weight:3}
    ]}));
    this.semanticFields.push(new SemanticField({name:'VulnÃ©rabilitÃ© organique',category:'organ_vulnerability',color:'purple',signals:[
      {name:'Lactates',extract:ps=>ps.biology.lactate,normalize:v=>Math.min(100,v*20),weight:2},
      {name:'Plaquettes',extract:ps=>ps.biology.platelets,normalize:v=>v<50?90:v<100?50:v<150?20:0,weight:1.5},
      {name:'Ã‚ge',extract:ps=>ps.ageMonths,normalize:v=>v<6?80:v<24?50:v<60?25:10,weight:1}
    ]}));
    this.patterns.push({name:'Cocktail rÃ©animation',match:ps=>{const dn=ps.drugs.map(d=>d.name.toLowerCase());const sed=['midazolam','propofol','kÃ©tamine','thiopental'].filter(s=>dn.some(d=>d.includes(s)));const ae=['phÃ©nytoÃ¯ne','valproate','levetiracetam','lacosamide'].filter(s=>dn.some(d=>d.includes(s)));if(sed.length>=1&&ae.length>=1&&ps.drugs.length>=4)return{confidence:0.7,description:`Cocktail: ${sed.join('+')} + ${ae.join('+')}`,implications:'Risque cumulatif'};return{confidence:0};}});
    this.patterns.push({name:'Cumul immunosuppresseur',match:ps=>{const dn=ps.drugs.map(d=>d.name.toLowerCase());const is=['mÃ©thylprednisolone','rituximab','cyclophosphamide','tocilizumab','anakinra'].filter(s=>dn.some(d=>d.includes(s)));if(is.length>=2)return{confidence:0.8,description:`${is.length} immunosuppresseurs`,implications:'Risque infectieux majeur'};return{confidence:0};}});
    this.rules.push({name:'Scan interactions',reference:'ANSM',evaluate:ps=>{const dn=ps.drugs.map(d=>d.name.toLowerCase());const det=[];this.interactions.forEach(inter=>{const all=[...inter.drugs,...(inter.also||[])];let found=false;if(inter.drugs.length===1){found=all.some(n=>dn.some(d=>d.includes(n)||n.includes(d)));if(found&&inter.conditionCheck&&!inter.conditionCheck(ps))found=false;}else{const mc=inter.drugs.filter(d=>dn.some(x=>x.includes(d.toLowerCase()))||(inter.also||[]).some(a=>dn.some(x=>x.includes(a.toLowerCase())))).length;found=mc>=2;}if(found)det.push(inter);});if(det.length>0)return{triggered:true,type:det.some(d=>d.severity==='critical')?'correction':'guard',message:det.map(d=>`${d.drugs.join('+')} [${d.severity}]`).join(', '),adjustment:{detectedInteractions:det}};return{triggered:false};}});
    this.rules.push({name:'ToxicitÃ© cumulÃ©e',reference:'RÃ©a pÃ©d',evaluate:ps=>{const dn=ps.drugs.map(d=>d.name.toLowerCase()),w=[];if(dn.some(d=>d.includes('propofol'))&&ps.hospDay>2)w.push('PRIS');if(dn.some(d=>d.includes('mÃ©thylprednisolone'))&&ps.hospDay>5)w.push('Cortico >5j');if(w.length>0)return{triggered:true,type:'guard',message:w.join(', ')};return{triggered:false};}});
  }
  _countInter(ps){const dn=ps.drugs.map(d=>d.name.toLowerCase());let c=0,w=0,i=0;this.interactions.forEach(inter=>{const all=[...inter.drugs,...(inter.also||[])];let found=false;if(inter.drugs.length===1){found=all.some(n=>dn.some(d=>d.includes(n)||n.includes(d)));if(found&&inter.conditionCheck&&!inter.conditionCheck(ps))found=false;}else{const mc=all.filter(n=>dn.some(d=>d.includes(n)||n.includes(d))).length;found=mc>=2;}if(found){if(inter.severity==='critical')c++;else if(inter.severity==='warning')w++;else i++;}});return{critical:c,warning:w,info:i};}
  analyzeContext(ps){const det=[];let cm=1.0;if(ps.tdeResult){const r=ps.tdeResult.synthesis.recommendations;if(r.length>0){det.push({type:'tde_reco',label:'Reco TDE',detail:r.map(x=>x.title).join(', '),icon:'ğŸ’Š'});cm=1.1;}}if(ps.drugs.length>=6){det.push({type:'polypharm',label:'Polypharmacie',detail:`${ps.drugs.length} mÃ©d`,icon:'âš—ï¸'});cm=Math.max(cm,1.2);}return{trend:det[0]?.type||'stable',details:det,contextModifier:cm};}
  computeCurve(ps){const d=[],lb=[];for(let i=1;i<=ps.hospDay;i++){d.push(Math.min(100,Math.round(ps.drugs.length*10*(i/ps.hospDay))));lb.push(`J${i}`);}return{trajectory:d,currentPosition:d.length-1,currentValue:d[d.length-1]||0,globalIntensity:d[d.length-1]||0,trend:(d[d.length-1]||0)>60?'high_risk':'moderate',curveData:d,labels:lb};}
  synthesize(ps,intention,context,rules,curve){
    const bi=intention.fields.find(f=>f.category==='drug_burden')?.intensity||0,ii=intention.fields.find(f=>f.category==='interaction_risk')?.intensity||0,vi=intention.fields.find(f=>f.category==='organ_vulnerability')?.intensity||0;
    let score=Math.min(100,Math.round((ii*0.5+bi*0.25+vi*0.25)*context.contextModifier));
    const alerts=[],recs=[];const ir=rules.find(r=>r.adjustment?.detectedInteractions);
    if(ir)ir.adjustment.detectedInteractions.forEach(inter=>{alerts.push({severity:inter.severity==='critical'?'critical':'warning',title:`Interaction: ${inter.drugs.join('+')}`,body:inter.mechanism,source:'PVE'});recs.push({priority:inter.severity==='critical'?'urgent':'high',title:`Action: ${inter.drugs.join('+')}`,body:inter.action,reference:inter.reference||''});});
    intention.patterns.filter(p=>p.confidence>0.5).forEach(p=>alerts.push({severity:'warning',title:p.name,body:p.description,source:'PVE Patterns'}));
    let level;if(score>=75)level='RISQUE Ã‰LEVÃ‰';else if(score>=50)level='RISQUE MODÃ‰RÃ‰';else if(score>=25)level='RISQUE FAIBLE';else level='RISQUE MINIMAL';
    return{score,level,levelColor:'',alerts,recommendations:recs};
  }
}

// â•â•â• PIPELINE â•â•â•
function runPipeline(ps) {
  const vps = new VPSEngine();
  const tde = new TDEEngine();
  const pve = new PVEEngine();
  
  const vr = vps.run(ps); ps.vpsResult = vr;
  const tr = tde.run(ps); ps.tdeResult = tr;
  const pr = pve.run(ps); ps.pveResult = pr;
  ps.alerts = [...vr.synthesis.alerts, ...tr.synthesis.alerts, ...pr.synthesis.alerts];
  ps.recommendations = [...tr.synthesis.recommendations, ...pr.synthesis.recommendations];
  return ps;
}

</script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENARIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SCENARIOS = {
  FIRES: {
    label:'FIRES typique', ageMonths:48,weightKg:16,hospDay:4,gcs:7,gcsHistory:[12,9],pupils:'sluggish',
    seizures24h:12,seizureDuration:45,seizureType:'refractory_status',
    crp:85,pct:1.2,ferritin:680,wbc:18,platelets:195,lactate:3.5,
    heartRate:155,sbp:80,dbp:45,spo2:93,temp:39.2,respRate:32,
    csfCells:120,csfProtein:0.78,csfAntibodies:'negative',
    drugs:[{name:'Midazolam',dose:''},{name:'Levetiracetam',dose:''},{name:'Methylprednisolone',dose:''},{name:'Cefotaxime',dose:''}],
    treatmentHistory:[{treatment:'Methylprednisolone IV',period:'J1-J3',response:'none'}]
  },
  NMDAR: {
    label:'Anti-NMDAR', ageMonths:168,weightKg:48,hospDay:7,gcs:11,gcsHistory:[13,12],pupils:'reactive',
    seizures24h:3,seizureDuration:5,seizureType:'focal_impaired',
    crp:12,pct:0.15,ferritin:180,wbc:8.5,platelets:220,lactate:1.2,
    heartRate:88,sbp:110,dbp:70,spo2:98,temp:37.4,respRate:18,
    csfCells:45,csfProtein:0.55,csfAntibodies:'nmdar',
    drugs:[{name:'Levetiracetam',dose:''},{name:'Rituximab',dose:''},{name:'Methylprednisolone',dose:''},{name:'Omeprazole',dose:''}],
    treatmentHistory:[{treatment:'Methylprednisolone IV',period:'J1-J3',response:'partial'},{treatment:'IVIg',period:'J2-J6',response:'partial'}]
  },
  CYTOKINE: {
    label:'Orage cytokinique', ageMonths:72,weightKg:22,hospDay:5,gcs:10,gcsHistory:[14,13],pupils:'sluggish',
    seizures24h:6,seizureDuration:12,seizureType:'generalized_tonic_clonic',
    crp:210,pct:4.5,ferritin:8500,wbc:2.8,platelets:65,lactate:5.2,
    heartRate:165,sbp:70,dbp:38,spo2:91,temp:40.1,respRate:38,
    csfCells:8,csfProtein:0.42,csfAntibodies:'pending',
    drugs:[{name:'Valproate',dose:''},{name:'Meropenem',dose:''},{name:'Midazolam',dose:''},{name:'Noradrenaline',dose:''},{name:'Methylprednisolone',dose:''},{name:'Amikacin',dose:''}],
    treatmentHistory:[{treatment:'Methylprednisolone IV',period:'J2-J4',response:'none'}]
  },
  REBOND: {
    label:'Rebond J5', ageMonths:96,weightKg:28,hospDay:5,gcs:11,gcsHistory:[13,14],pupils:'reactive',
    seizures24h:2,seizureDuration:3,seizureType:'focal_impaired',
    crp:25,pct:0.3,ferritin:280,wbc:11,platelets:210,lactate:1.8,
    heartRate:105,sbp:95,dbp:60,spo2:97,temp:38.2,respRate:22,
    csfCells:15,csfProtein:0.38,csfAntibodies:'pending',
    drugs:[{name:'Levetiracetam',dose:''},{name:'Methylprednisolone',dose:''},{name:'Paracetamol',dose:''}],
    treatmentHistory:[{treatment:'Methylprednisolone IV',period:'J1-J3',response:'partial'}]
  },
  STABLE: {
    label:'Stable (controle)', ageMonths:120,weightKg:32,hospDay:2,gcs:14,gcsHistory:[14,14],pupils:'reactive',
    seizures24h:0,seizureDuration:0,seizureType:'none',
    crp:3,pct:0.08,ferritin:90,wbc:9,platelets:280,lactate:0.9,
    heartRate:85,sbp:105,dbp:65,spo2:99,temp:37.1,respRate:18,
    csfCells:2,csfProtein:0.28,csfAntibodies:'negative',
    drugs:[{name:'Levetiracetam',dose:''},{name:'Paracetamol',dose:''}],
    treatmentHistory:[]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentPS = null;
var currentScenario = 'FIRES';

function runScenario(key){
  var d = SCENARIOS[key];
  currentScenario = key;
  currentPS = new PatientState(d);
  runPipeline(currentPS);
  renderAll();
}

function switchScenario(key){
  runScenario(key);
  toast('Scenario ' + key + ' - Pipeline execute');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPARKLINE SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sparkSVG(pts,tone){
  var w=320,h=44;
  var xs=pts.map(function(_,i){return i*(w/(pts.length-1))});
  var ys=pts.map(function(p){return h-(p/100)*h});
  var d='M '+xs.map(function(x,i){return x.toFixed(1)+' '+ys[i].toFixed(1)}).join(' L ');
  return '<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="none"><defs><linearGradient id="sg-'+tone+'" x1="0" x2="1"><stop offset="0" stop-color="var(--'+tone+')" stop-opacity="0"/><stop offset="1" stop-color="var(--'+tone+')" stop-opacity=".15"/></linearGradient></defs><path d="'+d+'" fill="none" stroke="var(--'+tone+')" stroke-width="2" stroke-linecap="round"/><path d="'+d+' L '+w+' '+h+' L 0 '+h+' Z" fill="url(#sg-'+tone+')"/></svg>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER SCORE CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScoreCard(engine,result){
  var map={vps:{card:'cardVPS',score:'vpsScore',trend:'vpsTrend',level:'vpsLevel',spark:'vpsSpark',detail:'vpsScoreDetail'},tde:{card:'cardTDE',score:'tdeScore',trend:'tdeTrend',level:'tdeLevel',spark:'tdeSpark',detail:'tdeScoreDetail'},pve:{card:'cardPVE',score:'pveScore',trend:'pveTrend',level:'pveLevel',spark:'pveSpark',detail:'pveScoreDetail'}};
  var ids=map[engine]; if(!ids)return;
  var s=result.synthesis.score;
  var lvl=levelFromScore(s);
  var root=document.getElementById(ids.card);
  root.className='scoreCard card tone-'+lvl.tone;
  animateNumber(document.getElementById(ids.score),s);
  document.getElementById(ids.level).textContent=lvl.key;
  var cv=result.curve;
  var td=cv.trajectory;
  var delta=td.length>=2?td[td.length-1]-td[td.length-2]:0;
  document.getElementById(ids.trend).textContent=(delta>3?'â†‘':delta<-3?'â†“':'â†’')+' '+Math.abs(Math.round(delta))+' pts';
  var pts=td.length>2?td:Array.from({length:8},function(_,i){return clamp(s+Math.sin(i/2)*5,0,100)});
  document.getElementById(ids.spark).innerHTML=sparkSVG(pts,lvl.tone);
  var tf=root.querySelector('.toneFrame');if(tf){tf.classList.remove('pulseOnce');if(lvl.tone==='critical')tf.classList.add('pulseOnce');}
  var det=document.getElementById(ids.detail);if(det)det.textContent=s+'/100 ['+lvl.key+']';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ENGINE DETAILS (4 layers)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFields(engine,result){
  var el=document.getElementById(engine+'Fields');if(!el)return;
  var tone=engine;
  el.innerHTML=result.intention.fields.map(function(f){
    var sigs=f.signals.map(function(s){
      var col=s.status==='critical'?'critical':s.status==='warning'?'severe':s.status==='moderate'?'moderate':'stable';
      return '<div class="sig"><span class="k">'+s.name+'</span><span class="v" style="color:var(--'+col+')">'+(s.rawValue!==null&&s.rawValue!==undefined?s.rawValue:'â€”')+' <small>('+s.normalized+'%)</small></span></div>';
    }).join('');
    return '<div class="sf" style="--tone:var(--'+tone+')"><div class="sfHead"><div><div style="font-weight:750">'+f.name+'</div><div class="muted" style="font-size:13px;margin-top:4px">'+f.interpretation+'</div></div><button class="btn secondary" style="height:36px" onclick="this.closest(\'.sf\').classList.toggle(\'open\')">'+f.intensity+'%</button></div><div class="bar"><i style="width:'+f.intensity+'%"></i></div><div class="sigList">'+sigs+'</div></div>';
  }).join('');
}

function renderContext(engine,result){
  var el=document.getElementById(engine+'Context');if(!el)return;
  var ctx=result.context;
  var html='<strong>Modificateur :</strong> x'+ctx.contextModifier.toFixed(2)+' &middot; <strong>Tendance :</strong> '+ctx.trend;
  if(ctx.details&&ctx.details.length>0){
    html+='<br>'+ctx.details.map(function(d){return (d.icon||'&bull;')+' '+d.label+' &mdash; '+d.detail}).join('<br>');
  }
  el.innerHTML=html;
}

function renderPatterns(engine,result){
  var el=document.getElementById(engine+'Patterns');if(!el)return;
  var pats=result.intention.patterns;
  if(!pats||pats.length===0){el.innerHTML='<span class="muted">Aucun pattern detecte</span>';return;}
  el.innerHTML=pats.map(function(p){
    var conf=Math.round(p.confidence*100);
    var tone=conf>80?'critical':conf>=60?'severe':'moderate';
    return '<span class="pBadge"><span class="dot" style="background:var(--'+tone+')"></span>'+p.name+' &middot; <strong>'+conf+'%</strong></span>';
  }).join('');
}

function renderRules(engine,result){
  var el=document.getElementById(engine+'Rules');if(!el)return;
  var rules=result.rules;
  if(!rules||rules.length===0){el.innerHTML='<span class="muted">Aucune regle declenchee</span>';return;}
  el.innerHTML=rules.map(function(r){
    return '<div class="rule"><div class="ruleHead"><span class="ruleType">'+(r.type||'validation').toUpperCase()+'</span><span class="meta">'+(r.reference||'')+'</span></div><div style="margin-top:8px;font-weight:750">'+r.name+'</div><div class="muted" style="margin-top:6px;line-height:1.5">'+r.message+'</div></div>';
  }).join('');
}

function renderCurve(engine,result){
  var el=document.getElementById(engine+'Curve');if(!el)return;
  var cv=result.curve;
  var pts=(cv.curveData&&cv.curveData.length>1)?cv.curveData:[result.synthesis.score];
  var labels=cv.labels||pts.map(function(_,i){return 'J'+(i+1)});
  var w=720,h=240,pad=28;
  var xs=pts.map(function(_,i){return pad+i*((w-2*pad)/Math.max(1,pts.length-1))});
  var ys=pts.map(function(p){return h-pad-(p/100)*(h-2*pad)});
  var d='M '+xs.map(function(x,i){return x.toFixed(1)+' '+ys[i].toFixed(1)}).join(' L ');
  var tone=levelFromScore(result.synthesis.score).tone;
  var gridLines='';
  for(var g=0;g<5;g++){var gy=pad+g*((h-2*pad)/4);gridLines+='<line x1="'+pad+'" x2="'+(w-pad)+'" y1="'+gy+'" y2="'+gy+'" stroke="var(--border)" stroke-opacity=".3"/>';}
  var dots=xs.map(function(x,i){return '<circle cx="'+x+'" cy="'+ys[i]+'" r="'+(i===xs.length-1?6:3)+'" fill="var(--'+tone+')" opacity="'+(i===xs.length-1?1:.5)+'"/>'}).join('');
  var labelsHtml=labels.map(function(l,i){return '<text x="'+xs[i]+'" y="'+(h-8)+'" fill="var(--text3)" font-size="10" text-anchor="middle">'+l+'</text>'}).join('');
  el.innerHTML='<svg viewBox="0 0 '+w+' '+h+'" width="100%" height="260"><defs><linearGradient id="bgz-'+engine+'" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="var(--critical)" stop-opacity=".08"/><stop offset=".5" stop-color="var(--moderate)" stop-opacity=".06"/><stop offset="1" stop-color="var(--stable)" stop-opacity=".06"/></linearGradient></defs><rect x="0" y="0" width="'+w+'" height="'+h+'" rx="16" fill="url(#bgz-'+engine+')" stroke="var(--border)" stroke-opacity=".4"/>'+gridLines+'<path d="'+d+'" fill="none" stroke="var(--'+tone+')" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>'+dots+labelsHtml+'</svg>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS & RECOMMENDATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAlerts(){
  var ps=currentPS;if(!ps)return;
  var alerts=ps.alerts||[];
  var c=document.getElementById('alertsContainer');
  var iconSvg='<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86l-8.39 14.51A2 2 0 0 0 3.62 21h16.76a2 2 0 0 0 1.72-2.63L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>';
  c.innerHTML=alerts.map(function(a){
    var cls=a.severity==='critical'?'alert-critical':a.severity==='warning'?'alert-warning':'alert-info';
    var src=a.source||'';
    var srcTone=src.indexOf('VPS')>=0?'vps':src.indexOf('TDE')>=0?'tde':'pve';
    return '<div class="alertCard '+cls+'"><div class="alertIcon">'+iconSvg+'</div><div class="alertBody"><div class="alertTitle">'+a.title+'</div><div class="muted" style="margin-top:6px;line-height:1.45">'+(a.body||'')+'</div><div class="alertMeta"><span class="badge"><span class="dot" style="background:var(--'+srcTone+')"></span>'+src+'</span></div></div></div>';
  }).join('');
  if(alerts.length===0) c.innerHTML='<div class="muted">Aucune alerte active &mdash; patient stable.</div>';
  var critCount=alerts.filter(function(a){return a.severity==='critical'}).length;
  var warnCount=alerts.filter(function(a){return a.severity==='warning'}).length;
  var badge=document.getElementById('alertCount');
  var badgeTone=critCount>0?'critical':warnCount>0?'severe':'stable';
  badge.innerHTML='<span class="dot" style="background:var(--'+badgeTone+')"></span>'+critCount+' crit &middot; '+warnCount+' warn';

  var recs=ps.recommendations||[];
  var rc=document.getElementById('recoContainer');
  rc.innerHTML=recs.map(function(r){
    var cls=r.priority==='urgent'?'danger':'secondary';
    return '<button class="btn '+cls+'" onclick="toast(\''+r.title.replace(/'/g,"\\'")+'\')">'+r.title+'</button>';
  }).join('');
  if(recs.length===0) rc.innerHTML='<span class="muted">Pas de recommandation active.</span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTimeline(){
  var ps=currentPS;if(!ps)return;
  var h=ps.neuro.gcsHistory;
  var days=h.map(function(g,i){return {d:'J'+(ps.hospDay-h.length+i),gcs:g,score:Math.round(((15-g)/12)*100)}});
  days.push({d:'J'+ps.hospDay,gcs:ps.neuro.gcs,score:Math.round(((15-ps.neuro.gcs)/12)*100)});
  var t=document.getElementById('timelineRow');
  t.innerHTML=days.map(function(x){
    var lvl=levelFromScore(x.score);
    return '<div class="day"><div class="d">'+x.d+'</div><div class="event">GCS '+x.gcs+'/15</div><div class="pill" style="border-color:color-mix(in oklab,var(--'+lvl.tone+') 55%,var(--border));background:color-mix(in oklab,var(--'+lvl.tone+') 14%,transparent);"><span class="dot" style="background:var(--'+lvl.tone+')"></span>'+x.score+'%</div></div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEADER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHeader(){
  var d=SCENARIOS[currentScenario];
  var age=d.ageMonths>=12?Math.floor(d.ageMonths/12)+' ans':d.ageMonths+' mois';
  document.getElementById('patientName').textContent=d.label;
  document.getElementById('patientMeta').textContent=age+' | '+d.weightKg+'kg | J'+d.hospDay;
  document.getElementById('lastRun').textContent='Pipeline V13 | '+currentScenario;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRASH TESTS (REAL V13)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CRASH_TESTS=[
  {id:'FIRES',checks:[
    {e:'VPS',d:'Score 70-100',t:function(ps){return ps.vpsResult.synthesis.score>=70&&ps.vpsResult.synthesis.score<=100}},
    {e:'VPS',d:'Niveau CRITIQUE',t:function(ps){return ps.vpsResult.synthesis.level==='CRITIQUE'}},
    {e:'VPS',d:'Pattern Deterioration',t:function(ps){return ps.vpsResult.intention.patterns.some(function(p){return p.name.indexOf('terioration')>=0})}},
    {e:'TDE',d:'Score >= 60',t:function(ps){return ps.tdeResult.synthesis.score>=60}},
    {e:'TDE',d:'Pattern FIRES',t:function(ps){return ps.tdeResult.intention.patterns.some(function(p){return p.name.indexOf('FIRES')>=0})}},
    {e:'TDE',d:'Echec 1ere ligne',t:function(ps){return ps.tdeResult.intention.patterns.some(function(p){return p.name.indexOf('chec')>=0})}},
    {e:'TDE',d:'Recommandation escalade',t:function(ps){return ps.tdeResult.synthesis.recommendations.length>0}},
    {e:'PVE',d:'Cocktail detecte',t:function(ps){return JSON.stringify(ps.pveResult).toLowerCase().indexOf('cocktail')>=0}}
  ]},
  {id:'NMDAR',checks:[
    {e:'VPS',d:'Score 10-40',t:function(ps){return ps.vpsResult.synthesis.score>=10&&ps.vpsResult.synthesis.score<=40}},
    {e:'VPS',d:'Score < 40',t:function(ps){return ps.vpsResult.synthesis.score<40}},
    {e:'TDE',d:'Score >= 40',t:function(ps){return ps.tdeResult.synthesis.score>=40}},
    {e:'TDE',d:'Pattern NMDAR',t:function(ps){return ps.tdeResult.intention.patterns.some(function(p){return p.name.indexOf('NMDAR')>=0})}},
    {e:'TDE',d:'NMDAR >= 90%',t:function(ps){return ps.tdeResult.intention.patterns.some(function(p){return p.name.indexOf('NMDAR')>=0&&p.confidence>=0.9})}},
    {e:'PVE',d:'Cumul immunosuppresseur',t:function(ps){return JSON.stringify(ps.pveResult).toLowerCase().indexOf('immunosuppresseur')>=0}}
  ]},
  {id:'CYTOKINE',checks:[
    {e:'VPS',d:'Score 75-100',t:function(ps){return ps.vpsResult.synthesis.score>=75&&ps.vpsResult.synthesis.score<=100}},
    {e:'VPS',d:'Niveau CRITIQUE',t:function(ps){return ps.vpsResult.synthesis.level==='CRITIQUE'}},
    {e:'VPS',d:'Orage cytokinique',t:function(ps){return ps.vpsResult.intention.patterns.some(function(p){return p.name.indexOf('Orage')>=0})}},
    {e:'VPS',d:'Deterioration',t:function(ps){return ps.vpsResult.intention.patterns.some(function(p){return p.name.indexOf('terioration')>=0})}},
    {e:'TDE',d:'Score >= 50',t:function(ps){return ps.tdeResult.synthesis.score>=50}},
    {e:'TDE',d:'Echec 1ere ligne',t:function(ps){return ps.tdeResult.intention.patterns.some(function(p){return p.name.indexOf('chec')>=0})}},
    {e:'PVE',d:'VPA+Meropenem interaction',t:function(ps){var r=ps.pveResult.rules;return r&&r.some(function(x){return x.adjustment&&x.adjustment.detectedInteractions&&x.adjustment.detectedInteractions.some(function(i){return i.severity==='critical'})})}},
    {e:'PVE',d:'Score PVE 50-100',t:function(ps){return ps.pveResult.synthesis.score>=50&&ps.pveResult.synthesis.score<=100}}
  ]},
  {id:'REBOND',checks:[
    {e:'VPS',d:'Score 25-55',t:function(ps){return ps.vpsResult.synthesis.score>=25&&ps.vpsResult.synthesis.score<=55}},
    {e:'VPS',d:'Pattern Rebond',t:function(ps){return ps.vpsResult.intention.patterns.some(function(p){return p.name.indexOf('Rebond')>=0})}},
    {e:'VPS',d:'Contexte >= x1.3',t:function(ps){return ps.vpsResult.context.contextModifier>=1.3}},
    {e:'TDE',d:'Score 20-55',t:function(ps){return ps.tdeResult.synthesis.score>=20&&ps.tdeResult.synthesis.score<=55}},
    {e:'PVE',d:'Score 0-35',t:function(ps){return ps.pveResult.synthesis.score>=0&&ps.pveResult.synthesis.score<=35}}
  ]},
  {id:'STABLE',checks:[
    {e:'VPS',d:'Score 0-25',t:function(ps){return ps.vpsResult.synthesis.score>=0&&ps.vpsResult.synthesis.score<=25}},
    {e:'VPS',d:'STABLE ou LEGER',t:function(ps){return ps.vpsResult.synthesis.level==='STABLE'||ps.vpsResult.synthesis.level==='LÃ‰GER'}},
    {e:'VPS',d:'Aucun pattern',t:function(ps){return ps.vpsResult.intention.patterns.length===0}},
    {e:'TDE',d:'Score 0-30',t:function(ps){return ps.tdeResult.synthesis.score>=0&&ps.tdeResult.synthesis.score<=30}},
    {e:'TDE',d:'MAINTIEN',t:function(ps){return ps.tdeResult.synthesis.level==='MAINTIEN'}},
    {e:'PVE',d:'Score 0-20',t:function(ps){return ps.pveResult.synthesis.score>=0&&ps.pveResult.synthesis.score<=20}}
  ]}
];

function runCrashTests(){
  var container=document.getElementById('crashResults');
  container.innerHTML='';
  var totalPass=0,totalFail=0;
  CRASH_TESTS.forEach(function(test){
    var d=SCENARIOS[test.id];
    var ps=new PatientState(d);
    runPipeline(ps);
    var pass=0,fail=0;
    var checks=test.checks.map(function(c){
      var ok=false;try{ok=c.t(ps)}catch(e){}
      if(ok)pass++;else fail++;
      return{ok:ok,engine:c.e,desc:c.d};
    });
    totalPass+=pass;totalFail+=fail;
    container.innerHTML+='<div class="card pad" style="margin-bottom:var(--sm);"><div style="display:flex;align-items:center;justify-content:space-between;gap:12px;"><div><strong>'+test.id+'</strong> &mdash; VPS:'+ps.vpsResult.synthesis.score+' TDE:'+ps.tdeResult.synthesis.score+' PVE:'+ps.pveResult.synthesis.score+'</div><span class="badge" style="background:color-mix(in oklab,var(--'+(fail===0?'stable':'critical')+') 14%,transparent);border-color:color-mix(in oklab,var(--'+(fail===0?'stable':'critical')+') 50%,var(--border));">'+pass+'/'+(pass+fail)+' '+(fail===0?'&#10003; PASS':'&#10007; FAIL')+'</span></div><div style="margin-top:var(--sm);display:flex;flex-wrap:wrap;gap:8px;">'+checks.map(function(c){return '<span class="badge" style="background:color-mix(in oklab,var(--'+(c.ok?'stable':'critical')+') 10%,transparent);border-color:color-mix(in oklab,var(--'+(c.ok?'stable':'critical')+') 40%,var(--border));"><span class="dot" style="background:var(--'+(c.ok?'stable':'critical')+')"></span>['+c.engine+'] '+c.desc+'</span>'}).join('')+'</div></div>';
  });
  var summary=document.getElementById('crashSummary');
  summary.style.display='block';
  document.getElementById('crashTotal').textContent=totalPass+'/'+(totalPass+totalFail)+' verifications';
  document.getElementById('crashStatus').innerHTML='<span class="dot" style="background:var(--'+(totalFail===0?'stable':'critical')+')"></span>'+(totalFail===0?'TOUS LES TESTS PASSENT':'CORRECTIONS NECESSAIRES');
  toast('Crash tests: '+totalPass+'/'+(totalPass+totalFail));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(key){
  $$('.view').forEach(function(v){v.style.display='none'});
  var el=document.getElementById('view-'+key);
  if(el)el.style.display='block';
  $$('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.view===key)});
  document.getElementById('breadcrumb').textContent=key==='cockpit'?'Cockpit':key==='vps'?'Moteur VPS':key==='tde'?'Moteur TDE':key==='pve'?'Moteur PVE':key==='tests'?'Crash Tests':key;
  $$('.nav a').forEach(function(n){n.classList.toggle('active',n.getAttribute('data-nav')===key)});
}

document.addEventListener('click',function(e){
  var a=e.target.closest('[data-nav]');
  if(a){e.preventDefault();showView(a.getAttribute('data-nav'));}
  var sc=e.target.closest('[data-scorejump]');
  if(sc){showView(sc.getAttribute('data-scorejump'));}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  var ps=currentPS;if(!ps)return;
  renderHeader();
  renderScoreCard('vps',ps.vpsResult);
  renderScoreCard('tde',ps.tdeResult);
  renderScoreCard('pve',ps.pveResult);
  renderAlerts();
  renderTimeline();
  ['vps','tde','pve'].forEach(function(k){
    var r=k==='vps'?ps.vpsResult:k==='tde'?ps.tdeResult:ps.pveResult;
    renderFields(k,r);
    renderContext(k,r);
    renderPatterns(k,r);
    renderRules(k,r);
    renderCurve(k,r);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initTheme();
runScenario('FIRES');
</script>
</body>
</html>
